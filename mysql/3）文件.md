>参数文件：告诉MySQL实例启动时，在哪可以找到数据库文件，并制定某些初始化参数，这些参数定义了某种内存结构的大小等设置
>
>日志文件：用来记录MySQL实例对某种条件做出响应时写入的文件，如错误日志文件、二进制文件、慢查询日志文件、查询日志文件等。
>
>socket文件：当用UNIX域套接字方式进行连接时需要的文件。
>
>pid文件：MySQL实例的进程ID文件。
>
>MySQL表结构文件：用来存放MySQL表结构定义文件。
>
>存储引擎文件：MySQL每个存储引擎都有自己的文件来保存各种数据。这些存储引擎真正存储了记录和索引等数据。





> 二进制文件十分关键，用于进行point in time的恢复以及复制环境的搭建（主从）。
>
> 重做日志文件也十分重要，用于记录InnoDB存储引擎的事务文件，为其提供可靠的事务。



[TOC]



## 3.1 参数文件



## 3.2 日志文件

常见的日志文件有：

1. 错误日志 error log
2. 二进制日志  binlog
3. 慢查询日志  slow query log
4. 查询日志 log



我们这里主要关注二进制日志，也就是常说的binlog。

### 二进制日志 binlog

二进制日志记录了对数据库执行变更的所有操作，即使操作没有导致数据库变化，那么操作也可能写入二进制文件。



二进制文件主要作用为：

1. 恢复  recovery：某些数据的恢复需要二进制文件，如point-in-time的恢复；
2. 复制 replication：通过复制与执行二进制文件，是远程数据库实例与当前数据库实例进行实时同步。
3. 审计 audit：用户通过二进制文件的信息进行审计，判断是否有对数据库进行注入的攻击。



影响二进制日志 binlog 信息与行为的参数：

1. max_binlog_size
2. Binlog_cache_size
3. Sync_binlog
4. binlog-do-db
5. binlog-ignore-db
6. log-slave-update
7. binlog_format



max_binlog_size，指定了单个二进制日志文件的最大值，超过该值，则产生新的二进制日志文件，后缀名+1，并记录到.index文件。

当使用事务的表存储引擎（如innodb）时，所有未提交的二进制日志都会被记录到一个缓存中，等事务提交后，直接将缓冲中的二进制文件写入二进制日志文件，该缓冲大小由binlog_cache_size决定，每一个会话有一个单独的缓冲。当事务的记录大于缓冲大小时，会写入临时文件中。binlog_cache_use 记录使用缓冲写入二进制日志的次数。binlog_cache_disk_use 记录了使用临时文件写二进制日志的次数。

默认二进制日志并不是每次写的时候同步到磁盘，参数sync_binlog = N ，表示每次写缓存多少次就同步到磁盘，默认为0，为了高可用性，最好设置值大于0。但存在一种情况，当一个事务发出提交前，二进制文件被写入了磁盘，但提交前发生了宕机，重启后，事务被回滚，但二进制文件已经记录了该事务信息，无法进行回滚。可以通过innodb_support_xa = 1 进行解决。（为什么可以这样？具体可以看mysql内部XA事务）

binlog-do-db、binlog-ignore-db，表示需要写入或者忽略哪些库的日志。

对于数据库中的slave角色，如果需要写入master的二进制日志到自己的实例中，需要设置log-slave_update。

binlog-format，影响记录二进制日志的格式。可设置的值有：STATEMENT、ROW、MIXED

1. STATEMENT ，二进制日志记录的是日志的逻辑SQL语句
2. ROW，记录表的行更改情况。（磁盘占用大，复制的网络开销也大）
3. MIXED格式下，默认采用STATEMENT记录二进制日志，但部分情况使用ROW格式





## 3.6 InnoDB存储引擎文件



### 3.6.1 表空间文件

分为共享表空间和独立表空间。

通过innodb_data_file_path参数，所有基于innodb的表数据都会记录到该共享表空间。

通过innodn_file_per_table参数，每个机遇innodb存储引擎的表参数一个独立的表空间。

注意：单独的表空间仅存储该表的数据、索引和插入缓冲BITMAP等信息



![image-20210513102816965](/Users/chenjiehao/Library/Mobile Documents/com~apple~CloudDocs/study/image/Innodb表存储引擎文件.png)



### 3.6.2 重做日志文件

默认情况下Innodb存储引擎的数据目录下有名为ib_logfile0和ib_logfile1两个文件。官方称为**InnoDB存储引擎的日志文件**，更准确的定义为重做日志文件（redo log file）。他们**记录了InnoDB存储引擎的事务日志**。

每个InnoDB存储引擎下至少有一个重做日志文件组（group），每个文件组至少有两个重做日志文件。会以循环的方式写入。

![image-20210513110249604](/Users/chenjiehao/Library/Mobile Documents/com~apple~CloudDocs/study/image/日志文件组.png)



#### 二进制日志（binlog）与InnoDB存储引擎重做日志（redo log）的区别

1. 二进制日志会记录所有与MySQL数据相关的日志记录，而重做日志只记录有关该存储引擎的事务日志。
2. 记录的内容不同：二进制日志文件记录的是关于一个事物的具体操作内容，即该日志是逻辑日志。而重做文件日志记录的关于每个页的更改的物理情况。
3. 写入的时间不同：二进制日志文件只在事务提交前进行提交，只写磁盘一次。重做日志却在事务进行的过程中不断被写入到磁盘中。



#### 重入日志文件格式

InnoDB中，对于不同的操作有着不同类型的重做日志格式，但它们有着基本的格式。

![image-20210514091020217](/Users/chenjiehao/Library/Mobile Documents/com~apple~CloudDocs/study/image/重做日志条目结构.png)



redo_log_type：占用一个字节，表示重做日志的类型。

space：采用压缩的形式，记录表的空间ID。

page_no：表示页的偏移量，同样采用压缩的方式。

redo_log_body：表示重做日志的数据部分，恢复数据时需要通过对应的函数进行解析。



#### 重做日志文件写入方式与条件

重做日志文件不是直接写入，而是先写入重做日志缓存，然后按照一定的顺序写入日志文件

![image-20210514091538747](/Users/chenjiehao/Library/Mobile Documents/com~apple~CloudDocs/study/image/重做日志写入过程.png)

从重做日志缓冲写入磁盘时，是按照512个字节，也就是一个扇区的大小进行写入的。因此可以保证写入必定是成功的。不需要有doublewrite。（为什么是必定成功的？因为是原子性操作）



写入磁盘的条件：

1. 主线程每秒将重做日志缓冲写入磁盘中。
2. 事务提交时将缓冲写入磁盘中，但受到innodb_flush_log_at_trx_commit控制。当值为0时，代表事务提交时，不将重做日志写入磁盘。当值为1时，代表事务提交时，将重做日志缓存同步写到磁盘，也就是伴随着fsync的调用。当值为2时，代表事务提交时，将重做日志写到文件系统的缓冲汇总，不能保证提交时，一定会写入文件中。

为了确保事务的ACID中的持久性，需要将值设置为1。0与2之间的区别在于，当数据库宕机而操作系统与服务器没有宕机时，由于日志文件保存在文件系统缓冲中，恢复时可以保证数据不丢失。



